csrr __tmp, scause   # è®€å– scause CSR
```

---
## stvec
stvec = Supervisor Trap Vector
        ^^^^^^^^^^  ^^^^  ^^^^^^
        â”‚           â”‚     â”‚
        â”‚           â”‚     â””â”€ å‘é‡ï¼ˆä½å€ï¼‰
        â”‚           â””â”€ é™·é˜±/ä¸­æ–·
        â””â”€ Supervisor æ¨¡å¼
```

**å…¨åï¼š** Supervisor Trap Vectorï¼ˆç›£ç£è€…é™·é˜±å‘é‡ï¼‰

---

## ğŸ“ æ ¸å¿ƒåŠŸèƒ½

**stvec å„²å­˜ã€Œä¸­æ–·è™•ç†ç¨‹å¼çš„ä½å€ã€**
```
ç•¶ç™¼ç”Ÿä¸­æ–·/ä¾‹å¤–æ™‚ï¼š
1. CPU è‡ªå‹•è·³è½‰åˆ° stvec æŒ‡å®šçš„ä½å€
2. é–‹å§‹åŸ·è¡Œä¸­æ–·è™•ç†ç¨‹å¼
```

---

## ğŸ” stvec çš„å…§å®¹

### **æ ¼å¼ï¼ˆ32 ä½å…ƒï¼‰**
```
stvec æš«å­˜å™¨ï¼ˆ32 bitsï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”
â”‚       BASE (30 bits)            â”‚MODEâ”‚
â”‚       ä½å€çš„é«˜ 30 ä½å…ƒ            â”‚(2) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜
 31                              2 1  0
```

---

### **MODE æ¬„ä½ï¼ˆæœ€ä½ 2 ä½å…ƒï¼‰**

| MODE å€¼ | æ„æ€ | èªªæ˜ |
|---------|------|------|
| **0** | **Directï¼ˆç›´æ¥æ¨¡å¼ï¼‰** | æ‰€æœ‰ä¸­æ–·éƒ½è·³åˆ°åŒä¸€å€‹ä½å€ |
| **1** | **Vectoredï¼ˆå‘é‡æ¨¡å¼ï¼‰** | ä¸åŒä¸­æ–·è·³åˆ°ä¸åŒä½å€ |
| 2-3 | ä¿ç•™ | æœªä½¿ç”¨ |

---

### **BASE æ¬„ä½ï¼ˆé«˜ 30 ä½å…ƒï¼‰**

**å„²å­˜ä¸­æ–·è™•ç†ç¨‹å¼çš„ä½å€ï¼ˆå¿…é ˆ 4-byte å°é½Šï¼‰**
```
BASE = ä½å€ >> 2

ä¾‹å¦‚ï¼š
  ä½å€ = 0x80200000
  BASE = 0x80200000 >> 2 = 0x20080000
  
stvec = (BASE << 2) | MODE
      = 0x80200000 | 0
      = 0x80200000




---

### **ä¸‰å€‹ CSR çš„æ„ç¾©**

| CSR        | å…¨å                     | å…§å®¹                |
|------------|-------------------------|---------------------|
| **scause** | Supervisor Cause        | ä¸­æ–·/ä¾‹å¤–çš„åŸå› ç¢¼      |
| **stval**  | Supervisor Trap Value   | ç›¸é—œçš„å€¼ï¼ˆä¾‹å¦‚éŒ¯èª¤ä½å€ï¼‰|
| **sepc**   | Supervisor Exception PC | ä¸­æ–·ç™¼ç”Ÿæ™‚çš„ PC       |

---

#### **scause çš„å€¼**
```
scause æœ€é«˜ä½å…ƒï¼š
  0 = ä¾‹å¤–ï¼ˆExceptionï¼‰
  1 = ä¸­æ–·ï¼ˆInterruptï¼‰

å…¶é¤˜ä½å…ƒ = åŸå› ç¢¼ï¼š
  0  = Instruction address misaligned
  1  = Instruction access fault
  2  = Illegal instruction
  8  = Environment call from U-mode (ç³»çµ±å‘¼å«)
  12 = Instruction page fault
  13 = Load page fault
  15 = Store page fault
  
ä¸­æ–·çš„å€¼ï¼š
  0x80000001 = Supervisor software interrupt
  0x80000005 = Supervisor timer interrupt
  0x80000009 = Supervisor external interrupt
```

---

#### **stval çš„å€¼**

æ ¹æ“š scause çš„ä¸åŒï¼Œstval æœ‰ä¸åŒæ„ç¾©ï¼š
```
å¦‚æœæ˜¯é é¢éŒ¯èª¤ï¼š
  stval = é€ æˆéŒ¯èª¤çš„è¨˜æ†¶é«”ä½å€

å¦‚æœæ˜¯éæ³•æŒ‡ä»¤ï¼š
  stval = éæ³•æŒ‡ä»¤æœ¬èº«

å¦‚æœæ˜¯ç³»çµ±å‘¼å«ï¼š
  stval = 0ï¼ˆé€šå¸¸ä¸ä½¿ç”¨ï¼‰
```

---

#### **sepc çš„å€¼**
```
sepc = ç™¼ç”Ÿä¸­æ–·/ä¾‹å¤–æ™‚çš„ PCï¼ˆç¨‹å¼è¨ˆæ•¸å™¨ï¼‰

è¿”å›æ™‚ï¼š
  sret æœƒè·³åˆ° sepc çš„ä½å€
  
è™•ç†ç³»çµ±å‘¼å«æ™‚éœ€è¦ä¿®æ”¹ï¼š
  sepc += 4  // è·³é ecall æŒ‡ä»¤ï¼ˆ4 bytesï¼‰
```

---

## ğŸ¬ å®Œæ•´åŸ·è¡Œæµç¨‹
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ™‚åˆ» 1ï¼šä¸­æ–·ç™¼ç”Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç¡¬é«”è‡ªå‹•ï¼š
  scause = 8           (ç³»çµ±å‘¼å«)
  sepc = 0x80001234    (ecall æŒ‡ä»¤çš„ä½å€)
  stval = 0
  è·³è½‰åˆ° kernel_entry


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ™‚åˆ» 2ï¼škernel_entry ä¿å­˜æš«å­˜å™¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

çµ„åˆèªè¨€ï¼š
  csrw sscratch, sp
  addi sp, sp, -124
  sw ra, 4*0(sp)
  sw gp, 4*1(sp)
  ...
  sw sp, 4*30(sp)
  
å †ç–Šå¸ƒå±€ï¼ˆæŒ‰ç…§ trap_frame çµæ§‹ï¼‰ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ra  = 0x... â”‚ â† sp = 0x800FFF84
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ gp  = 0x... â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ ...         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ™‚åˆ» 3ï¼šå‘¼å« handle_trap
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

çµ„åˆèªè¨€ï¼š
  mv a0, sp              # a0 = 0x800FFF84
  call handle_trap       # å‘¼å« C å‡½æ•¸


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ™‚åˆ» 4ï¼šhandle_trap è®€å–è³‡è¨Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

C èªè¨€ï¼š
  void handle_trap(struct trap_frame *f) {
      // f = 0x800FFF84
      
      // è®€å– CSR
      uint32_t scause = READ_CSR(scause);   // 8
      uint32_t stval = READ_CSR(stval);     // 0
      uint32_t user_pc = READ_CSR(sepc);    // 0x80001234
      
      // å¯ä»¥è®€å–æš«å­˜å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
      // uint32_t a7 = f->a7;  // ç³»çµ±å‘¼å«è™Ÿç¢¼
      // uint32_t a0 = f->a0;  // ç¬¬ä¸€å€‹åƒæ•¸
      
      // é¡¯ç¤ºéŒ¯èª¤ä¸¦åœæ­¢
      PANIC("unexpected trap scause=%x, stval=%x, sepc=%x\n", 
            scause, stval, user_pc);
  }


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ™‚åˆ» 5ï¼šPANIC é¡¯ç¤ºéŒ¯èª¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¼¸å‡ºï¼š
  PANIC: kernel.c:42: unexpected trap scause=8, stval=0, sepc=80001234
  
ç„¶å¾Œï¼š
  while (1) {}  // ç„¡çª®è¿´åœˆï¼Œç³»çµ±åœæ­¢